<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debugger Factory - Revolutionary AI Development Platform</title>
    <style>
        /* Apple Minimal Design System */
        :root {
            --apple-white: #ffffff;
            --apple-gray-1: #f5f5f7;
            --apple-gray-2: #e8e8ed;
            --apple-gray-3: #d2d2d7;
            --apple-text-primary: #1d1d1f;
            --apple-text-secondary: #86868b;
            --apple-blue: #007aff;
            --apple-green: #34c759;
            --apple-red: #ff3b30;
            --apple-purple: #af52de;
            --apple-gray: #8e8e93;
            --font-primary: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            --border-radius: 12px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --transition: 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--apple-gray-1);
            color: var(--apple-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .header {
            background: var(--apple-white);
            border-bottom: 1px solid var(--apple-gray-2);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--apple-text-primary);
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 32px;
        }

        .nav-item {
            color: var(--apple-text-secondary);
            text-decoration: none;
            font-weight: 400;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item:hover {
            color: var(--apple-blue);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Cards */
        .card {
            background: var(--apple-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--apple-gray-2);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            min-height: 44px;
        }

        .btn-primary {
            background: var(--apple-blue);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--apple-white);
            color: var(--apple-text-primary);
            border: 1px solid var(--apple-gray-3);
        }

        .btn-secondary:hover {
            background: var(--apple-gray-1);
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 18px;
            min-height: 52px;
        }

        /* Voice Interface */
        .voice-interface {
            text-align: center;
            padding: 48px 0;
        }

        .voice-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--apple-blue);
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: var(--transition);
            margin: 24px auto;
            display: block;
        }

        .voice-button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .voice-button.recording {
            background: var(--apple-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .project-card {
            background: var(--apple-white);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--apple-gray-2);
            transition: var(--transition);
            cursor: pointer;
        }

        .project-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .project-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--apple-text-primary);
        }

        .project-description {
            color: var(--apple-text-secondary);
            margin-bottom: 16px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--apple-green);
        }

        .status-completed {
            background: rgba(0, 122, 255, 0.1);
            color: var(--apple-blue);
        }

        /* Forms */
        .input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--apple-gray-3);
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
            font-size: 16px;
            background: var(--apple-white);
            transition: var(--transition);
            outline: none;
        }

        .input:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .textarea {
            resize: vertical;
            min-height: 120px;
        }

        .select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Conversation */
        .conversation {
            max-width: 800px;
            margin: 0 auto;
        }

        .message {
            display: flex;
            margin-bottom: 24px;
            align-items: flex-start;
            gap: 16px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.ai {
            background: var(--apple-blue);
            color: white;
        }

        .message-avatar.user {
            background: var(--apple-gray-3);
            color: var(--apple-text-primary);
        }

        .message-content {
            background: var(--apple-white);
            padding: 16px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 70%;
            border: 1px solid var(--apple-gray-2);
        }

        .message.user .message-content {
            background: var(--apple-blue);
            color: white;
        }

        /* Error Styles */
        .error-message {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid var(--apple-red);
            color: var(--apple-red);
            padding: 16px;
            border-radius: var(--border-radius);
            margin: 16px 0;
        }

        .success-message {
            background: rgba(52, 199, 89, 0.1);
            border: 1px solid var(--apple-green);
            color: var(--apple-green);
            padding: 16px;
            border-radius: var(--border-radius);
            margin: 16px 0;
        }

        .error-details {
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        /* Loading and Progress Styles */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--apple-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--apple-blue), var(--apple-purple));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-sm { margin-top: 8px; }
        .mt-md { margin-top: 16px; }
        .mt-lg { margin-top: 24px; }
        .mt-xl { margin-top: 32px; }
        .mb-sm { margin-bottom: 8px; }
        .mb-md { margin-bottom: 16px; }
        .mb-lg { margin-bottom: 24px; }
        .flex { display: flex; }
        .flex-gap { gap: 16px; }
        .flex-wrap { flex-wrap: wrap; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--apple-white);
            border-radius: var(--border-radius);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.16);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--apple-text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu { display: none; }
            .container { padding: 16px; }
            .grid { grid-template-columns: 1fr; }
            .message-content { max-width: 85%; }
            .voice-button { width: 100px; height: 100px; font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="logo">🚀 AI Debugger Factory</div>
            <ul class="nav-menu">
                <li><a class="nav-item" onclick="showSection('dashboard')">Dashboard</a></li>
                <li><a class="nav-item" onclick="showSection('voice-conversation')">VoiceBotics</a></li>
                <li><a class="nav-item" onclick="showSection('business-validation')">Business Intelligence</a></li>
                <li><a class="nav-item" onclick="showSection('dream-engine')">Layer 1 Build</a></li>
                <li><a class="nav-item" onclick="showSection('debug-engine')">Layer 2 Debug</a></li>
            </ul>
            <button class="btn btn-secondary">Sign Out</button>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="container">
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="app-section">
            <div class="card">
                <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 16px;">Welcome to AI Debugger Factory</h1>
                <p style="font-size: 1.25rem; color: var(--apple-text-secondary); margin-bottom: 32px;">Transform your ideas into deployed applications with revolutionary AI-powered development.</p>
                
                <div class="flex flex-gap flex-wrap">
                    <button class="btn btn-primary btn-large" onclick="showSection('voice-conversation')">
                        🎤 Start AI Cofounder Conversation
                    </button>
                    <button class="btn btn-secondary btn-large" onclick="showSection('dream-engine')">
                        ⚡ Generate Code Directly
                    </button>
                </div>
            </div>

            <!-- Projects Grid -->
            <div class="grid">
                <div class="project-card" onclick="openProject('sample-1')">
                    <div class="project-title">Sample Task Manager</div>
                    <div class="project-description">AI-generated task management application with real-time collaboration</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                        <span style="font-size: 14px; color: var(--apple-text-secondary);">Created: 2 days ago</span>
                        <span class="status-badge status-active">ACTIVE</span>
                    </div>
                </div>
                
                <div class="project-card" onclick="openProject('sample-2')">
                    <div class="project-title">E-commerce Platform</div>
                    <div class="project-description">Full-stack e-commerce solution with payment integration</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                        <span style="font-size: 14px; color: var(--apple-text-secondary);">Created: 1 week ago</span>
                        <span class="status-badge status-completed">DEPLOYED</span>
                    </div>
                </div>
                
                <div class="project-card" onclick="createNewProject()">
                    <div class="text-center" style="padding: 40px; color: var(--apple-text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">+</div>
                        <div>Create New Project</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VoiceBotics AI Cofounder Section -->
        <section id="voice-conversation" class="app-section hidden">
            <div class="card">
                <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 24px; text-align: center;">🎤 VoiceBotics AI Cofounder</h2>
                <p class="text-center" style="color: var(--apple-text-secondary); margin-bottom: 32px;">Have a natural conversation about your business idea. I'll help validate your strategy and generate production-ready code.</p>
                
                <div class="voice-interface">
                    <button id="voice-button" class="voice-button" onclick="toggleVoiceRecording()">🎤</button>
                    <div id="voice-status" style="font-size: 18px; font-weight: 500; color: var(--apple-text-secondary);">Click to start conversation</div>
                </div>
                
                <div class="conversation" id="conversation-container">
                    <!-- Conversation messages will appear here -->
                </div>
                
                <div class="mt-xl">
                    <textarea 
                        id="text-input" 
                        class="input textarea" 
                        placeholder="Or type your message here..."
                        onkeypress="handleTextInput(event)"
                    ></textarea>
                    <button class="btn btn-primary mt-md" onclick="sendTextMessage()">Send Message</button>
                </div>
            </div>
        </section>

        <!-- Business Intelligence Section -->
        <section id="business-validation" class="app-section hidden">
            <div class="card">
                <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 24px;">🧠 Business Intelligence & Validation</h2>
                <p style="color: var(--apple-text-secondary); margin-bottom: 32px;">Let me analyze your business idea, research competitors, and validate your strategy before we build.</p>
                
                <div class="mb-lg">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Describe your business idea:</label>
                    <textarea 
                        id="business-idea-input"
                        class="input textarea"
                        placeholder="Example: I want to create a platform that helps dog owners find trusted pet sitters in their neighborhood..."
                    ></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="startBusinessValidation()">
                    Analyze & Validate Business Idea
                </button>
                
                <div id="validation-results" class="mt-xl hidden">
                    <!-- Validation results will appear here -->
                </div>
            </div>
        </section>

        <!-- Layer 1 Build (Dream Engine) Section -->
        <section id="dream-engine" class="app-section hidden">
            <div class="card">
                <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 24px;">⚡ Layer 1 Build - Dream Engine</h2>
                <p style="color: var(--apple-text-secondary); margin-bottom: 32px;">Describe what you want to build, and I'll generate production-ready code with strategic analysis.</p>
                
                <div class="mb-lg">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Project Description:</label>
                    <textarea 
                        id="build-request-input"
                        class="input textarea"
                        placeholder="Example: Build a task management app with user authentication, real-time collaboration, and mobile responsiveness..."
                    ></textarea>
                </div>
                
                <div class="flex flex-gap mb-lg">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tech Stack:</label>
                        <select id="tech-stack-select" class="input select">
                            <option value="fastapi-react">FastAPI + React + PostgreSQL</option>
                            <option value="django-vue">Django + Vue.js + MySQL</option>
                            <option value="nodejs-angular">Node.js + Angular + MongoDB</option>
                            <option value="flask-vanilla">Flask + Vanilla JS + SQLite</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Deployment:</label>
                        <select id="deployment-select" class="input select">
                            <option value="render">Render (Recommended)</option>
                            <option value="vercel">Vercel + Railway</option>
                            <option value="heroku">Heroku</option>
                            <option value="aws">AWS EC2</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-large" onclick="startDreamGeneration()">
                    ⚡ Generate Complete Application
                </button>
            </div>
        </section>

        <!-- Layer 2 Debug Section -->
        <section id="debug-engine" class="app-section hidden">
            <div class="card">
                <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 24px;">🔧 Layer 2 Debug - Professional Development</h2>
                <p style="color: var(--apple-text-secondary); margin-bottom: 32px;">Load your GitHub repository for professional debugging with Monaco Editor and AI assistance.</p>
                
                <div class="mb-lg">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">GitHub Repository URL:</label>
                    <input 
                        id="github-repo-input"
                        type="url"
                        class="input"
                        placeholder="https://github.com/username/repository"
                    />
                </div>
                
                <button class="btn btn-primary" onclick="loadGitHubRepo()">
                    📤 Load Repository
                </button>
                
                <div id="debug-workspace" class="mt-xl hidden">
                    <div style="background: var(--apple-gray-1); border-radius: var(--border-radius); padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px;">Monaco Editor</h3>
                        <div style="background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 8px; font-family: 'Monaco', 'Menlo', monospace; min-height: 300px;">
                            <div style="color: #569cd6;">// Your code will appear here</div>
                            <div style="color: #6a9955;">// Professional debugging environment ready</div>
                            <div style="color: #ce9178;">console.log('Welcome to AI Debugger Factory!');</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-gap">
                        <button class="btn btn-primary" onclick="askAIDebugQuestion()">🤖 Ask AI Debug Question</button>
                        <button class="btn btn-secondary" onclick="runTests()">🧪 Run Tests</button>
                        <button class="btn btn-secondary" onclick="syncToGitHub()">📤 Sync to GitHub</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <h3 id="modal-title">Modal Title</h3>
            <div id="modal-body">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // FIXED FRONTEND - CORRECT BACKEND CONNECTIONS
        // ==========================================

        const API_BASE = window.location.origin;
        let currentUser = null;
        let authToken = localStorage.getItem('auth_token');
        let isRecording = false;
        let mediaRecorder = null;
        let conversationHistory = [];
        let currentSessionId = null;

        // ==========================================
        // 1. AUTHENTICATION (OPTIONAL)
        // ==========================================

        async function checkAuthentication() {
            // Authentication is optional - app works without login
            if (!authToken) {
                console.log('ℹ️ No auth token - using guest mode');
                return false;
            }
            
            try {
                console.log('🔍 Checking authentication...');
                const response = await fetch(`${API_BASE}/api/v1/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    console.log('✅ Authentication successful:', currentUser);
                    return true;
                } else {
                    console.log('ℹ️ Authentication failed - using guest mode');
                    localStorage.removeItem('auth_token');
                    authToken = null;
                    return false;
                }
            } catch (error) {
                console.log('ℹ️ Auth check failed - using guest mode:', error.message);
                return false;
            }
        }

        // ==========================================
        // 2. VOICE RECORDING (REAL BACKEND)
        // ==========================================

        async function toggleVoiceRecording() {
            const button = document.getElementById('voice-button');
            const status = document.getElementById('voice-status');
            
            if (!isRecording) {
                try {
                    console.log('🎤 Requesting microphone access...');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        mimeType = 'audio/webm;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                    } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                        mimeType = 'audio/ogg;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                        mimeType = 'audio/wav';
                    }
                    
                    console.log('🎵 Using MIME type:', mimeType);
                    mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
                    
                    const audioChunks = [];
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        console.log('🎵 Audio recorded, size:', audioBlob.size, 'bytes, type:', mimeType);
                        
                        stream.getTracks().forEach(track => track.stop());
                        await processVoiceInput(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    button.classList.add('recording');
                    button.textContent = '⏹️';
                    status.textContent = 'Recording... Click to stop';
                    console.log('✅ Recording started');
                    
                } catch (error) {
                    console.error('❌ Microphone access failed:', error);
                    showError('Microphone Error', `Unable to access microphone: ${error.message}`);
                }
            } else {
                if (mediaRecorder) {
                    mediaRecorder.stop();
                    console.log('⏹️ Recording stopped');
                }
                isRecording = false;
                button.classList.remove('recording');
                button.textContent = '🎤';
                status.textContent = 'Processing voice input...';
            }
        }

    async function processVoiceInput(audioBlob) {
        try {
        // STEP 1: Start conversation session (if not exists)
        if (!currentSessionId) {
            console.log('🚀 Starting new conversation session...');
            const sessionResponse = await fetch(`${API_BASE}/api/v1/voice-conversation/start-conversation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                body: JSON.stringify({
                    initial_input: "Voice conversation started",
                    voice_mode: true
                })
            });
            
            console.log('📡 Session response status:', sessionResponse.status);
            
            if (!sessionResponse.ok) {
                const errorText = await sessionResponse.text();
                throw new Error(`Session start failed (${sessionResponse.status}): ${errorText}`);
            }
            
            const sessionData = await sessionResponse.json();
            currentSessionId = sessionData.session_id;
            console.log('✅ Session started:', currentSessionId);
        }
        
        // STEP 2: Transcribe audio
        console.log('🔄 Transcribing audio...');
        const formData = new FormData();
        let filename = 'voice_input.webm';
        if (audioBlob.type.includes('mp4')) {
            filename = 'voice_input.mp4';
        } else if (audioBlob.type.includes('ogg')) {
            filename = 'voice_input.ogg';
        } else if (audioBlob.type.includes('wav')) {
            filename = 'voice_input.wav';
        }
        
        formData.append('audio_file', audioBlob, filename);
        
        // ✅ FIX: Use proper URL construction instead of undefined transcribeUrl
        const transcribeResponse = await fetch(`${API_BASE}/api/v1/voice-conversation/transcribe-audio/${currentSessionId}`, {
            method: 'POST',
            headers: authToken ? {
                'Authorization': `Bearer ${authToken}`
            } : {},
            body: formData
        });
        
        console.log('📡 Transcribe response status:', transcribeResponse.status);
        
        if (!transcribeResponse.ok) {
            const errorText = await transcribeResponse.text();
            throw new Error(`Transcription failed (${transcribeResponse.status}): ${errorText}`);
        }
        
        const transcriptionData = await transcribeResponse.json();
        console.log('✅ Transcription result:', transcriptionData);
        
        // Add transcription to conversation
        addMessageToConversation('user', `🎤 ${transcriptionData.transcription}`);
        
        // STEP 3: Continue conversation
        await continueConversation(currentSessionId, transcriptionData.transcription);
        
    } catch (error) {
        console.error('❌ Voice processing failed:', error);
        showError('Voice Processing Error', `Voice processing failed: ${error.message}`);
        
        // Reset status for user to try again
        const status = document.getElementById('voiceStatus');
        if (status) {
            status.textContent = 'Ready to record voice input';
        }
    }
    }

        async function continueConversation(sessionId, userInput) {
            try {
                console.log('💬 Continuing conversation with session:', sessionId);
                const response = await fetch(`${API_BASE}/api/v1/voice-conversation/process-turn/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                    user_response: userInput,
                    voice_mode: false
                    })
                });
                
                console.log('📡 Conversation response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Conversation failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ AI response:', result);
                
                // Add AI response to conversation
                addMessageToConversation('ai', result.ai_response || result.response || JSON.stringify(result));
                
                // Update conversation history
                conversationHistory.push({
                    user: userInput,
                    ai: result.ai_response || result.response,
                    session_id: sessionId
                });
                
            } catch (error) {
                console.error('❌ Conversation continuation failed:', error);
                showError('Conversation Error', `Conversation failed: ${error.message}`);
                addMessageToConversation('system', `❌ Conversation failed: ${error.message}`);
            }
        }

        // ==========================================
        // 3. BUSINESS INTELLIGENCE (REAL BACKEND)
        // ==========================================

        async function startBusinessValidation() {
        const businessIdea = document.getElementById('business-idea-input').value.trim();
    
    if (!businessIdea) {
        showError('Input Required', 'Please describe your business idea first.');
        return;
    }
    
    // Show loading modal
    showModal('Business Validation', `
        <div style="margin-bottom: 16px;">
            <strong>Analyzing:</strong> ${businessIdea}
        </div>
        <div class="loading-spinner"></div>
        <p style="margin-top: 16px;">🔄 Processing business intelligence analysis...</p>
    `);
    
    try {
        console.log('🧠 Starting business validation for:', businessIdea);
        
        // Generate a conversation ID
        const conversationId = `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const requestData = {
            conversation_id: conversationId,  // ← ADDED THIS LINE
            business_idea: {
                description: businessIdea,
                problem_statement: businessIdea,
                target_market: "To be determined through analysis",
                solution_description: "AI-powered solution",
                monetization: "To be determined"
             }       
        };
        
        const response = await fetch(`${API_BASE}/api/v1/business-intelligence/analyze-market`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(authToken && { 'Authorization': `Bearer ${authToken}` })
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('📡 Business validation response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Business validation error response:', errorText);
            throw new Error(`Business validation failed (${response.status})`);
        }
        
        const validation = await response.json();
        console.log('✅ Business validation result:', validation);
        
        // Show validation results
        showModal('Business Validation Results', `
            <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                <h3>✅ Market Analysis Complete</h3>
                
                <div class="success-message" style="margin: 16px 0;">
                    <strong>Market Size:</strong> ${validation.market_size}<br>
                    <strong>Growth Rate:</strong> ${validation.growth_rate}<br>
                    <strong>Confidence Score:</strong> ${(validation.confidence_score * 100).toFixed(0)}%
                </div>
                
                <h4>Key Opportunities:</h4>
                <ul>
                    ${validation.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                </ul>
                
                <h4>Potential Threats:</h4>
                <ul>
                    ${validation.threats.map(threat => `<li>${threat}</li>`).join('')}
                </ul>
                
                <h4>Key Trends:</h4>
                <ul>
                    ${validation.key_trends.map(trend => `<li>${trend}</li>`).join('')}
                </ul>
                
                <h4>Recommendations:</h4>
                <ul>
                    ${validation.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="proceedToCodeGeneration('${validation.analysis_id}')">
                        ⚡ Proceed to Code Generation
                    </button>
                </div>
            </div>
        `);
        
        // Store the analysis ID for later use
        window.lastAnalysisId = validation.analysis_id;
        
    } catch (error) {
        console.error('❌ Business validation error:', error);
        showError('Validation Failed', error.message);
    }
}

        // ==========================================
        // 4. CODE GENERATION (REAL BACKEND)
        // ==========================================

        async function startDreamGeneration() {
            const buildRequest = document.getElementById('build-request-input').value.trim();
            
            if (!buildRequest) {
                showError('Input Required', 'Please describe what you want to build.');
                return;
            }
            
            proceedToCodeGeneration('direct');
        }

        async function proceedToCodeGeneration(validationId) {
            closeModal();
            
            const buildRequest = document.getElementById('build-request-input')?.value.trim() || 
                                document.getElementById('business-idea-input')?.value.trim() || 
                                'Create a web application';
            
            // Show code generation modal
            showModal('Code Generation', `
                <div style="margin-bottom: 16px;">
                    <strong>Generating code for your project...</strong>
                </div>
                <div class="loading-spinner"></div>
                <div id="generation-progress">
                    <p>🔄 Calling backend API...</p>
                    <p style="font-size: 14px; color: var(--apple-text-secondary);">Endpoint: POST ${API_BASE}/api/v1/dreamengine/generate-code</p>
                </div>
            `);
            
            try {
                console.log('⚡ Starting code generation for:', buildRequest);
                
                const response = await fetch(`${API_BASE}/api/v1/dreamengine/generate-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                        project_description: buildRequest,
                        tech_stack: document.getElementById('tech-stack-select')?.value || "fastapi-react",
                        deployment_target: document.getElementById('deployment-select')?.value || "render",
                        validation_id: validationId,
                        generation_type: 'full_stack_application',
                        include_deployment_config: true,
                        target_platforms: ["web", "mobile"]
                    })
                });
                
                console.log('📡 Code generation response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Code generation failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ Code generation result:', result);
                
                showModal('Code Generation Complete', `
                    <div style="text-align: center;">
                        <h3>✅ Code Generation Complete!</h3>
                        
                        <div class="success-message">
                            <strong>✅ Backend Response Received!</strong><br>
                            Your application code has been generated by the AI backend.
                        </div>
                        
                        <p><strong>Project:</strong> ${buildRequest}</p>
                        <p><strong>Generation ID:</strong> ${result.generation_id || result.project_id || 'generated'}</p>
                        
                        <h4>🔍 Backend Response:</h4>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto; text-align: left; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                        
                        <div style="margin: 20px 0;">
                            <button onclick="downloadProject('${result.generation_id || result.project_id || 'generated'}')" class="btn btn-primary">
                                📥 Download Project
                            </button>
                        </div>
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ Code generation failed:', error);
                showError('Code Generation Error', `Code generation failed: ${error.message}`);
            }
        }

        // ==========================================
        // 5. TEXT MESSAGE SYSTEM (REAL BACKEND)
        // ==========================================

        async function sendTextMessage() {
            const input = document.getElementById('text-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            addMessageToConversation('user', message);
            
            // Use session-based conversation
            if (currentSessionId) {
                await continueConversation(currentSessionId, message);
            } else {
                // Start new session for text input
                try {
                    console.log('💬 Starting new text conversation session...');
                    const sessionResponse = await fetch(`${API_BASE}/api/v1/voice-conversation/start-conversation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                        },
                        body: JSON.stringify({
                        initial_input: message,
                        voice_mode: false
                        })

                    });
                    
                    console.log('📡 Text session response status:', sessionResponse.status);
                    
                    if (!sessionResponse.ok) {
                        const errorText = await sessionResponse.text();
                        throw new Error(`Session start failed (${sessionResponse.status}): ${errorText}`);
                    }
                    
                    const sessionData = await sessionResponse.json();
                    currentSessionId = sessionData.session_id;
                    console.log('✅ Text session started:', currentSessionId);
                    
                    await continueConversation(currentSessionId, message);
                } catch (error) {
                    console.error('❌ Text conversation failed:', error);
                    showError('Text Conversation Error', `Text conversation failed: ${error.message}`);
                    addMessageToConversation('system', `❌ Text conversation failed: ${error.message}`);
                }
            }
        }

        function handleTextInput(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTextMessage();
            }
        }

        // ==========================================
        // 6. UTILITY FUNCTIONS
        // ==========================================

        function addMessageToConversation(sender, content) {
            const container = document.getElementById('conversation-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${sender}">
                    ${sender === 'ai' ? '🤖' : sender === 'user' ? '👤' : '⚠️'}
                </div>
                <div class="message-content">
                    ${content}
                </div>
            `;
            
            container.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function showError(title, message) {
            showModal(title, `
                <div class="error-message">
                    <strong>❌ Error:</strong> ${message}
                    <div class="error-details">
                        This error came directly from the backend API or network request.
                        Check the browser console for more details.
                        
                        Expected API endpoints:
                        • POST /api/v1/voice-conversation/start-conversation
                        • POST /api/v1/voice-conversation/transcribe-audio/{sessionId}
                        • POST /api/v1/voice-conversation/process-turn/{sessionId}
                        • POST /api/v1/business-intelligence/analyze-market
                        • POST /api/v1/dreamengine/generate-code
                        • POST /api/v1/dreamengine/analyze-strategic-requirements
                    </div>
                </div>
            `);
        }

        function showSection(sectionId) {
            console.log('🔄 Switching to section:', sectionId);
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // ==========================================
        // 7. GITHUB AND DEBUG FUNCTIONS (REAL BACKEND)
        // ==========================================

        async function loadGitHubRepo() {
            const repoUrl = document.getElementById('github-repo-input').value.trim();
            
            if (!repoUrl) {
                showError('Input Required', 'Please enter a GitHub repository URL.');
                return;
            }
            
            try {
                console.log('📤 Loading GitHub repository:', repoUrl);
                const response = await fetch(`${API_BASE}/api/v1/github/load-repository`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                        repository_url: repoUrl
                    })
                });
                
                console.log('📡 GitHub load response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub load failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ GitHub load result:', result);
                
                document.getElementById('debug-workspace').classList.remove('hidden');
                showModal('Repository Loaded', `
                    <div class="success-message">
                        <strong>✅ Backend Response Received!</strong><br>
                        Repository loaded successfully: ${repoUrl}
                    </div>
                    
                    <h4>🔍 Backend Response:</h4>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                    <div style="margin-top: 20px;">
                        <button onclick="closeModal()" class="btn btn-primary">
                            Start Debugging
                        </button>
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ GitHub repository load failed:', error);
                showError('GitHub Load Error', `GitHub repository load failed: ${error.message}`);
            }
        }

        async function askAIDebugQuestion() {
            const question = prompt('What debugging question do you have?');
            if (!question) return;
            
            try {
                console.log('🤖 Asking AI debug question:', question);
                const response = await fetch(`${API_BASE}/api/v1/debug/ask-question`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                        question: question,
                        context: 'debug_session'
                    })
                });
                
                console.log('📡 AI debug response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`AI debug failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ AI debug result:', result);
                
                showModal('AI Debug Response', `
                    <div style="text-align: left;">
                        <h4>❓ Your Question:</h4>
                        <p>${question}</p>
                        
                        <div class="success-message">
                            <strong>✅ Backend Response Received!</strong><br>
                            AI debug analysis complete.
                        </div>
                        
                        <h4>🤖 AI Response:</h4>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ AI debug question failed:', error);
                showError('AI Debug Error', `AI debug question failed: ${error.message}`);
            }
        }

        async function runTests() {
            try {
                console.log('🧪 Running tests...');
                const response = await fetch(`${API_BASE}/api/v1/debug/run-tests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                        test_type: 'all'
                    })
                });
                
                console.log('📡 Test run response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Test run failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ Test results:', result);
                
                showModal('Test Results', `
                    <div style="text-align: left;">
                        <div class="success-message">
                            <strong>✅ Backend Response Received!</strong><br>
                            Test execution complete.
                        </div>
                        
                        <h4>🧪 Test Execution Results:</h4>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ Test run failed:', error);
                showError('Test Run Error', `Test run failed: ${error.message}`);
            }
        }

        async function syncToGitHub() {
            try {
                console.log('📤 Syncing to GitHub...');
                const response = await fetch(`${API_BASE}/api/v1/github/sync-changes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                        commit_message: 'Auto-sync from AI Debugger Factory'
                    })
                });
                
                console.log('📡 GitHub sync response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub sync failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ GitHub sync result:', result);
                
                showModal('GitHub Sync Complete', `
                    <div style="text-align: left;">
                        <div class="success-message">
                            <strong>✅ Backend Response Received!</strong><br>
                            GitHub sync complete.
                        </div>
                        
                        <h4>📤 Sync Results:</h4>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ GitHub sync failed:', error);
                showError('GitHub Sync Error', `GitHub sync failed: ${error.message}`);
            }
        }

        // ==========================================
        // 8. PROJECT FUNCTIONS (REAL BACKEND)
        // ==========================================

        function createNewProject() {
            showModal('Create New Project', `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Project Name:</label>
                    <input id="new-project-name" type="text" class="input" placeholder="My Awesome Project" />
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Description:</label>
                    <textarea id="new-project-desc" class="input textarea" placeholder="Describe your project..."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="createProjectBackend()">Create Project</button>
                </div>
            `);
        }

        async function createProjectBackend() {
            const name = document.getElementById('new-project-name').value.trim();
            const description = document.getElementById('new-project-desc').value.trim();
            
            if (!name) {
                showError('Input Required', 'Please enter a project name.');
                return;
            }
            
            try {
                console.log('📝 Creating new project:', name);
                const response = await fetch(`${API_BASE}/api/v1/projects/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description
                    })
                });
                
                console.log('📡 Project creation response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Project creation failed (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ Project creation result:', result);
                
                closeModal();
                showModal('Project Created', `
                    <div style="text-align: left;">
                        <h4>✅ Project Created Successfully!</h4>
                        <p><strong>Name:</strong> ${name}</p>
                        <p><strong>Description:</strong> ${description}</p>
                        
                        <div class="success-message">
                            <strong>✅ Backend Response Received!</strong><br>
                            Project created successfully in the backend.
                        </div>
                        
                        <h4>🔍 Backend Response:</h4>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</pre>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="closeModal(); showSection('voice-conversation');">
                                Start Conversation
                            </button>
                        </div>
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ Project creation failed:', error);
                showError('Project Creation Error', `Project creation failed: ${error.message}`);
            }
        }

        function openProject(projectId) {
            showModal('Open Project', `
                <p>📂 Opening project: ${projectId}</p>
                <p><em>This would call the backend to load project details...</em></p>
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="closeModal(); showSection('debug-engine');">
                        🔧 Debug in Layer 2
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal(); showSection('dream-engine');">
                        ⚡ Generate More Code
                    </button>
                </div>
            `);
        }

        async function downloadProject(projectId) {
            try {
                console.log('📥 Downloading project:', projectId);
                const response = await fetch(`${API_BASE}/api/v1/dreamengine/download-code/${projectId}`, {
                    method: 'GET',
                    headers: authToken ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {}
                });
                
                console.log('📡 Download response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Download failed (${response.status}): ${errorText}`);
                }
                
                // Handle file download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `project-${projectId}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('✅ Download complete');
                showModal('Download Complete', `
                    <div class="success-message">
                        <strong>✅ Download Complete!</strong><br>
                        Project ${projectId} downloaded successfully!
                    </div>
                `);
                
            } catch (error) {
                console.error('❌ Project download failed:', error);
                showError('Download Error', `Project download failed: ${error.message}`);
            }
        }

        // ==========================================
        // 9. INITIALIZATION
        // ==========================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 AI Debugger Factory - FIXED BACKEND CONNECTIONS');
            console.log('🌐 API Base URL:', API_BASE);
            
            const isAuthenticated = await checkAuthentication();
            console.log('🔐 Authentication status:', isAuthenticated);
            
            showSection('dashboard');
            
            // Log all expected endpoints for debugging
            console.log('📋 Expected API endpoints (FIXED):');
            console.log('  • POST /api/v1/voice-conversation/start-conversation');
            console.log('  • POST /api/v1/voice-conversation/transcribe-audio/{sessionId}');
            console.log('  • POST /api/v1/voice-conversation/process-turn/{sessionId}');
            console.log('  • POST /api/v1/business-intelligence/analyze-market');
            console.log('  • POST /api/v1/dreamengine/analyze-strategic-requirements');
            console.log('  • POST /api/v1/dreamengine/generate-code');
            console.log('  • GET  /api/v1/dreamengine/download-code/{generationId}');
            console.log('  • POST /api/v1/github/load-repository');
            console.log('  • POST /api/v1/debug/ask-question');
            console.log('  • POST /api/v1/debug/run-tests');
            console.log('  • POST /api/v1/github/sync-changes');
            console.log('  • POST /api/v1/projects/create');
            
            console.log('✅ Frontend initialized - Backend service issues FIXED!');
            console.log('🔧 Backend services should now initialize properly');
            console.log('📡 API endpoints should now return real responses instead of 404');
        });

        async function checkAuthentication() {
    try {
        const response = await fetch(`${API_BASE}/api/v1/auth/check`, {
            method: 'GET',
            headers: authToken ? {
                'Authorization': `Bearer ${authToken}`
            } : {}
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.authenticated) {
                currentUser = data;
                console.log('✅ Authenticated user:', data.email);
            } else {
                console.log('ℹ️ Guest mode active');
            }
            return data.authenticated;
        }
    } catch (error) {
        console.log('ℹ️ Guest mode (no auth check):', error.message);
        return false;
    }
}

async function generateProductionCode() {
    const buildRequest = document.getElementById('build-request-input').value.trim();
    
    if (!buildRequest) {
        showError('Input Required', 'Please describe what you want to build.');
        return;
    }
    
    // Generate project ID
    const projectId = `proj_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    showModal('Generating Code', `
        <div class="loading-spinner"></div>
        <p>🚀 Starting strategic analysis...</p>
        <p style="font-size: 14px; color: var(--apple-text-secondary);">This may take 30-60 seconds</p>
    `);
    
    try {
        // Step 1: Strategic Analysis
        console.log('📊 Starting strategic analysis...');
        const analysisResponse = await fetch(`${API_BASE}/api/v1/dreamengine/analyze-strategic-requirements`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(authToken && { 'Authorization': `Bearer ${authToken}` })
            },
            body: JSON.stringify({
                project_id: projectId,
                founder_agreement: {
                    business_description: buildRequest,
                    technical_requirements: buildRequest,
                    target_audience: "To be determined",
                    key_features: buildRequest.split('.').filter(s => s.trim()),
                    monetization_strategy: "To be determined"
                },
                additional_requirements: null
            })
        });
        
        if (!analysisResponse.ok) {
            const errorText = await analysisResponse.text();
            console.error('Strategic analysis error:', errorText);
            throw new Error(`Strategic analysis failed: ${errorText}`);
        }
        
        const analysis = await analysisResponse.json();
        console.log('✅ Strategic analysis complete:', analysis);
        
        // Update modal
        document.getElementById('modal-body').innerHTML = `
            <div class="loading-spinner"></div>
            <p>✅ Strategic analysis complete!</p>
            <p>🔨 Generating production code...</p>
        `;
        
        // Step 2: Code Generation
        const codeGenResponse = await fetch(`${API_BASE}/api/v1/dreamengine/generate-production-code`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(authToken && { 'Authorization': `Bearer ${authToken}` })
            },
            body: JSON.stringify({
                analysis_id: analysis.analysis_id,
                custom_requirements: {}
            })
        });
        
        if (!codeGenResponse.ok) {
            const errorText = await codeGenResponse.text();
            console.error('Code generation error:', errorText);
            throw new Error(`Code generation failed`);
        }
        
        const codeResult = await codeGenResponse.json();
        console.log('✅ Code generation complete:', codeResult);
        
        // Show results
        showModal('Code Generation Complete!', `
            <div style="text-align: left;">
                <h3>✅ Your Application is Ready!</h3>
                
                <div class="success-message" style="margin: 16px 0;">
                    <strong>Project ID:</strong> ${codeResult.project_id}<br>
                    <strong>Files Generated:</strong> ${codeResult.generated_files.length}<br>
                    <strong>Quality Score:</strong> ${(codeResult.quality_score * 100).toFixed(0)}%<br>
                    <strong>Deployment Ready:</strong> ${codeResult.ready_for_github_upload ? 'Yes' : 'No'}
                </div>
                
                <h4>Project Structure:</h4>
                <pre style="background: var(--apple-grey-100); padding: 12px; border-radius: 8px; overflow-x: auto;">
${JSON.stringify(codeResult.project_structure, null, 2)}
                </pre>
                
                <h4>Deployment Instructions:</h4>
                <p style="white-space: pre-wrap;">${codeResult.deployment_instructions}</p>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="proceedToDebugEngine('${codeResult.project_id}')">
                        🔧 Proceed to Debug Engine
                    </button>
                    <button class="btn btn-secondary" onclick="downloadGeneratedCode('${codeResult.generation_id}')">
                        📥 Download Code
                    </button>
                </div>
            </div>
        `);
        
        // Store the result for later use
        window.lastGenerationResult = codeResult;
        
    } catch (error) {
        console.error('❌ Code generation error:', error);
        showError('Generation Failed', error.message);
    }
}
function proceedToCodeGeneration(analysisId) {
    // Switch to dream engine tab
    showSection('dream-engine');
    closeModal();
}

function proceedToDebugEngine(projectId) {
    // Switch to debug engine tab
    showSection('debug-engine');
    closeModal();
    // You can auto-populate the debug session with the project ID
    if (window.lastGenerationResult) {
        console.log('Project ready for debugging:', projectId);
    }
}

async function downloadGeneratedCode(generationId) {
    try {
        const response = await fetch(`${API_BASE}/api/v1/dreamengine/download/${generationId}`, {
            headers: {
                ...(authToken && { 'Authorization': `Bearer ${authToken}` })
            }
        });
        
        if (!response.ok) {
            throw new Error('Download failed');
        }
        
        // Create download link
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai-debugger-code-${generationId}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Download error:', error);
        showError('Download Failed', 'Could not download generated code');
    }
}
    </script>
</body>
</html>

